
<source>
  @type  http
  port  9880
  bind 0.0.0.0
</source>

<source>
  @type  forward
  @id    input1
  port  24224
</source>


<filter vehicle.log>
  @type record_transformer
  enable_ruby
  
  <record>
    location ${JSON.parse("{}").merge({"lat": record["Lat"], "lon": record["Lon"]})}
    car_id ${record["Car_no"]}
    speed ${record["Speed"]}
    @timestamp ${record["Timestamp"]}
  </record>

  remove_keys Lat, Lon, Car_no, Speed, Timestamp
</filter>


<filter vehicle.map>
  @type record_transformer
  enable_ruby
  
  <record>
    car_id ${record["CarId"]}
    location ${JSON.parse(record["LocationJSON"].gsub("Lat", "lat").gsub("Lon", "lon"))}
    startSecond ${record["StartSecond"]}
    bbox_north ${record["BboxNorth"]}
    bbox_south ${record["BboxSouth"]}
    bbox_east ${record["BboxEast"]}
    bbox_west ${record["BboxWest"]}
  </record>

  remove_keys CarId, LocationJSON, StartSecond, BboxNorth, BboxSouth, BboxEast, BboxWest

</filter>

<match vehicle.log>
  @type elasticsearch
    host elastic
    port 9200
    index_name simulation-1-log
    type_name _doc
    <buffer>
      buffer_type memory
      flush_interval 5s
      retry_limit 17
      retry_wait 1.0
      num_threads 4
    </buffer>
</match>

<match vehicle.map>
  @type copy

  # <store>
  #   @type stdout
  # </store>

  <store>
    @type elasticsearch
    host elastic
    port 9200
    index_name simulation-1-map
    type_name _doc
    <buffer>
      buffer_type memory
      flush_interval 5s
      retry_limit 17
      retry_wait 1.0
      num_threads 4
    </buffer>
  </store>
</match>
